## 目标
- 将当前实现彻底对齐论文的三大组件与端到端增强路径：DEN‑Phy、CM‑FSC、GLC‑Former，并以论文的最终重建逻辑输出增强图像。
- 保留运行稳定性与现有接口，同时提供“组件开关/消融”以复现实验表格。

## 关键改动
### 1) CM‑FSC：跨模态调制严格按式(7)(8)(9)
- LearnableWaveletTransform：保持多层系数 Ψ_j(F) 输出形状一致。
- CrossModalModulator：
  - 为每层 j 增加 `P_layers[j]: 1x1 Conv` 将 F_j 映射到 3 通道伪图像；`e_j = CLIP.encode_image(Resize(P_j(F_j)))`。
  - `γ_j = MLP(Concat[avg_pool(F_j), e_j])`。
  - 计算 `Q_e_j = Q_layers[j](e_j)/√d` 与 `V_e_j = V_layers[j](e_j)`；
  - 按公式：`F̂_j = F_j + γ_j ⊙ σ(Q_e_j) ⊙ V_e_j`；缓存全部 `{F̂_j}` 与 `{e_j}`。
- 频率损失 L_freq：对齐式(10)，`∑_j ||F̂_j − F_j^clip||²`，其中 `F_j^clip` 由 `e_j` 引导（可通过线性投影到 F_j 维度）。

### 2) GLC‑Former：全局/局部双路径与门控融合
- Flatten & concat 得到 X；
- 全局路径：`Y_global = Softmax(XW_Q (XW_K)^T / √C) XW_V ⊙ X`；
- 局部路径：将 X 划分为 K×K 窗口，分别计算 `Y_local^w` 并插值回原尺寸；
- 门控融合：`α = σ(W_α·[Y_global; Interp({Y_local^w})])`，`Y = α⊙Y_global + (1−α)⊙Interp({Y_local^w})`；缓存 `Y_global/Y_local/α` 供一致性损失。
- 逆小波包重建：`J = Ψ^{-1}(Y)` 得到图像域重建（与当前逆波列保持一致，但按 token 划分回多尺度后再逐步上采样融合）。

### 3) DEN‑Phy：Retinex+SDN+可微CRF按式(2)(3)
- RetinexModule 产出 `R, L` 与噪声 `N(σ_s,σ_c)`；
- 可微 CRF：`κ[x] = (1+κ)x / (1+κx)`，实现可学习参数 `κ>0`；
- 重建：`Î_phy = κ[(R + N(σ_s,σ_c)) ∘ L]`。

### 4) 最终增强图 I（论文逻辑）
- 按摘要：最终增强由“逆小波包重建与逆CRF”得到：
  - 方案A（Full，默认）：`I = κ^{-1}(J)`，其中 `κ^{-1}` 为 CRF 的逆映射近似（数值安全可用牛顿迭代或近似函数）。
  - 保留方案B（Hybrid，可选）：门控融合 `I = β·Î_phy + (1−β)·J`，`β = mean(L)` 或学习门，便于稳定训练；
- 命令行新增 `--mode {full, den_phy, cmfsc, hybrid}` 对应消融。

### 5) 训练损失与消融开关
- 总损失：`L = λ_R L_recon + λ_P L_phy + λ_F L_freq + λ_C L_cons`；
  - L_recon：`||R̂◦L̂ − I||₁ + ||∇L̂||₁ + ||∇R̂||²`（保留现实现）。
  - L_phy：与当前实现一致（utils_Net）。
  - L_freq：对齐 CM‑FSC。
  - L_cons：对齐 GLC‑Former 的门控融合特征。 
- 保留 TV/曝光/颜色/空间一致性正则（已有实现），作为稳定项并可权重化。
- Warmup：先仅用 `L_recon/L_phy/TV`，若 `--mode full` 在若干 epoch 后加入 `λ_F/λ_C`。

### 6) 运行接口与稳定性
- 新参数：`--mode`、`--window_size`（GLC）、`--exp_mean`（曝光目标）、`--crop_size`（已暴露）、`--scheduler {multistep,cosine}` 等。
- 维持已加的 `--use_ref_metrics` 布尔评估与 `referance_val` 路径。
- 统一 dtype（float32）与设备迁移；保存验证增强图到 `results/val_I/`。

## 验证与交付
- 快速命令（Full 模式）：
  - `CUDA_VISIBLE_DEVICES=0 python main_Net.py --data_train ... --data_val ... --referance_val ... --mode full --lambda_F 0.2 --lambda_C 0.1 --warmup_epochs 5 --tv_weight 0.1 --grad_clip 1.0 --scheduler cosine`
- 指标：PSNR/SSIM/LPIPS 或 BRISQUE/CLIP-IQA；输出增强图用于质检。
- 交付：代码改动集中在 `net/lformer_Net.py` 的调制/GLC/重建与 `main_Net.py` 的前向融合与损失拼接；不改变数据/训练器整体结构。