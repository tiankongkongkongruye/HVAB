## 目标
- 让训练的优化方向以“提升到正常亮度”为主，同时保持颜色与结构不失真。
- 在不改变论文三组件（DEN‑Phy、CM‑FSC、GLC‑Former）前提下，增加亮度导向的损失与调度，并调整已有权重。

## 新增亮度损失（utils_Net.py）
- L_brightness（亮度对齐）：
  - 计算灰度 `Y = mean(I,dim=1,keepdim=True)`；目标亮度 `t = brightness_target`（默认 0.7）。
  - 采用 Huber 或 L1：`|mean(Y) − t|` + `β·|p90(Y) − t_high|`（高亮百分位，默认 `t_high=0.8`）。
- L_lowclip（暗部抬升）：
  - 对低于阈值 `τ=0.05` 的像素施加铰链损失：`relu(τ − Y)` 的均值，减少大片过暗区域。
- L_dynrange（动态范围）：
  - 约束 `std(Y)` 接近目标 `dr_target`（默认 0.25），避免过度平滑。

## 入口参数（main_Net.py）
- 新增 CLI：
  - `--brightness_target`（默认 0.7）、`--brightness_band`（默认 0.1）
  - `--lambda_brightness`、`--lambda_lowclip`、`--lambda_dynrange`
  - 这三者也支持 schedule：`--lambda_brightness_schedule` 等，与现有 `phase_epochs` 调度一致。

## 损失组合（main_Net.py）
- 在 `train()` 中：
  - 计算 `L_brightness + L_lowclip + L_dynrange` 并按阶段权重加入总损失。
  - 同时提升 `lambda_exp_schedule`（如设为 `0.7,0.7,0.7`）并降低 `tv_weight_schedule`（如 `0.05,0.03,0.03`）。
  - 记录到日志：`mean_luma/clip_ratio/std_luma/gate_mean`，便于观测亮度与门控状态。

## 学习式门控与输出头（net/lformer_Net.py）
- 已加入 `gating_net` 与轻量解码头；在此基础上：
  - 初始化 `gating_net` 最后一层偏置，使 gate 初始均值约 0.5（避免饱和）；
  - 可选增加门控先验损失 `L_gate_prior = |mean(gate) − gate_target|`（早期 `gate_target≈0.5`），适度约束融合比例。

## 调参建议（默认 schedule）
- `phase_epochs=20,60`
- 亮度：`lambda_brightness=0.8,0.6,0.4`；`lambda_lowclip=0.2,0.1,0.1`；`lambda_dynrange=0.2,0.2,0.2`
- 曝光：`lambda_exp=0.7,0.7,0.7`；TV：`tv=0.05,0.03,0.03`
- 目标：`brightness_target=0.7`，`brightness_band=0.1`；必要时将 `exp_mean=0.7`。

## 运行示例
- `CUDA_VISIBLE_DEVICES=1 python main_Net.py --mode hybrid --glc_global_mode center --global_tokens_limit 8192 --phase_epochs 20,60 --lambda_brightness_schedule 0.8,0.6,0.4 --lambda_lowclip_schedule 0.2,0.1,0.1 --lambda_dynrange_schedule 0.2,0.2,0.2 --lambda_exp_schedule 0.7,0.7,0.7 --tv_weight_schedule 0.05,0.03,0.03 --brightness_target 0.7 --brightness_band 0.1 --exp_mean 0.7 --crop_size 128 --warmup_epochs 10 --scheduler cosine --grad_clip 1.0 --clip_text "low light image" "well-lit image"`

## 验证与预期
- 观测 `mean_luma/clip_ratio/std_luma/gate_mean` 与 SSIM/LPIPS 曲线；亮度应快速提升（mean_luma→0.65~0.75），暗部占比下降；SSIM/LPIPS在阶段 B/C 继续改善。

## 影响说明
- 仅新增亮度导向的损失与调度，保持论文组件与损失框架不变；增强输出更贴近“正常亮度”。