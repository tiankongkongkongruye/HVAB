## 目标
- 将现有实现完全对齐论文方法：DEN‑Phy、CM‑FSC、GLC‑Former，并用“逆小波包重建 + 逆 CRF”生成最终增强图像 I。
- 保留稳定训练与评估接口，新增组件开关以支持消融实验和复现实验表格。

## 改动范围
- 不改动数据加载与整体训练框架结构；仅更新模型前向、损失组合与少量 CLI 参数。
- 保持现有评估（PSNR/SSIM/LPIPS 与 BRISQUE/CLIP‑IQA）、日志、权重保存路径不变。

## 代码改动点
### CM‑FSC（跨模态频率‑语义协同先验）
1. LearnableWaveletTransform：保持多层特征 `F_j = Ψ_j(I)` 输出结构。
2. CrossModalModulator（`net/lformer_Net.py`）：
   - 为每层 j 增加 `P_j`（1×1 Conv），将 `F_j` 映射到 3 通道伪图像；`e_j = CLIP.encode_image(Resize(P_j(F_j)))`。
   - 计算 `γ_j = MLP(Concat[avg(F_j), e_j])`、`Q_e_j = Q_j(e_j)/√d`、`V_e_j = V_j(e_j)`，形成 `F̂_j = F_j + γ_j ⊙ σ(Q_e_j) ⊙ V_e_j`。
   - 缓存 `{F̂_j}`、`{e_j}` 用于 `L_freq` 与后续重建。
3. 频率损失 `L_freq`（`utils_Net.py`）：
   - 实现 `∑_j ||F̂_j − F_j^clip||²`，其中 `F_j^clip = T_j(e_j)`，`T_j` 为线性投影到 `F_j` 维度（新增或复用 `V_j`）。

### GLC‑Former（全局‑局部一致性 Transformer）
1. Flatten 并拼接多尺度特征为序列 X。
2. 全局路径：`Y_global = Softmax(XW_Q (XW_K)^T / √C) XW_V ⊙ X`。
3. 局部路径：将 X 划分为 K×K 窗口，计算每窗 `Y_local^w` 并插值为原序列。
4. 门控融合：`α = σ(W_α·[Y_global; Interp({Y_local^w})])`，`Y = α⊙Y_global + (1−α)⊙Interp({Y_local^w})`；缓存 `Y_global/Y_local/α` 供 `L_cons`。
5. 逆小波包重建：`J = Ψ^{-1}(Y)` 生成图像域特征栈（逐级上采样融合，保持尺寸一致）。

### DEN‑Phy（Retinex + SDN + 可微 CRF）
1. RetinexModule：输出 `R,L` 与噪声 `N(σ_s,σ_c)`（已有）。
2. 可微 CRF：`κ[x] = (1+κ)x / (1+κx)`（已有），确保 `κ>0`；
3. 物理重建：`Î_phy = κ[(R + N(σ_s,σ_c)) ∘ L]`。

### 最终增强图 I 与输出路径
- Full 模式：`I = κ^{-1}(J)`，实现 `κ^{-1}` 的数值近似（稳定版：牛顿迭代/近似分式映射）。
- Hybrid 模式（便于稳定）：`I = β·Î_phy + (1−β)·J`，其中 `β` 为学习门或 `mean(L)`。
- 保持原返回接口 `(L, el=L, R, X=input, I)`。

### 损失与训练（`main_Net.py`）
- 总损失：`L = λ_R L_recon + λ_P L_phy + λ_F L_freq + λ_C L_cons + L_reg`。
  - `L_recon`、`L_phy` 复用现实现；`L_freq` 与 `L_cons`按上述新特征；
  - 正则 `L_reg` 包含 TV/曝光/颜色/空间一致性（已有）。
- Warmup：仅 `L_recon/L_phy/TV`，后期启用 `λ_F/λ_C`；保留梯度裁剪与可选调度（cosine/multistep）。

### CLI 参数与模式
- 新增：`--mode {full, den_phy, cmfsc, hybrid}`，`--window_size`（GLC），`--exp_mean`（曝光目标），保留 `--crop_size`、`--scheduler`、`--use_ref_metrics`。

## 实施步骤
### Phase 1（CM‑FSC 完整化，1–2 小时）
- 在 `net/lformer_Net.py` 完善 CrossModalModulator：加入 `P_j`、`Q_j/V_j` 完整计算与缓存；修正 dtype/device，保证与 CLIP 对齐。
- 在 `utils_Net.py` 扩展 `freq_loss` 支持 `F_j^clip=T_j(e_j)` 输入。
- 验证：单张前向 + 单步训练，确保不报错且 `modulated_features` 形状正确。

### Phase 2（GLC‑Former 门控融合与逆重建，2–3 小时）
- 完善全局/局部路径与门控融合；缓存 `y_global/y_local/α`。
- 实现逆小波包重建得到 `J`；添加形状与窗口划分鲁棒性（必要时 fallback 至插值）。
- 验证：随机张量形状一致、无维度错误；简单图像通过重建。

### Phase 3（DEN‑Phy 与最终 I 输出，1 小时）
- 实现 `κ^{-1}` 近似并集成 Full 模式；加入 Hybrid 门控；
- 在 `main_Net.py` 切换输出来源与损失组合，按 `--mode` 控制。

### Phase 4（训练稳态与评估集成，1 小时）
- 调整 warmup、权重默认值；保存验证增强图到 `results/val_I/`；
- 保留三指标/两指标评估；加入日志标记模式与消融开关。

## 验证与度量
- 单元验证：前向维度、梯度、数值稳定（dtype float32）；
- 指标：LOL‑v1/LOL‑v2‑real 上 PSNR/SSIM/LPIPS 曲线，预计 Full 模式优于 Hybrid，且逐 epoch 改善速度加快；
- 可视化：`results/val_I/` 与参考图对比。

## 风险与回退
- 逆 CRF 近似不稳 → fallback 到 Hybrid；
- 窗口划分不整除 → 动态补齐/插值；
- CLIP 抽取耗时 → 预缓存或批量推理；必要时降低频率权重。

## 交付物
- 修改过的 `net/lformer_Net.py`、`utils_Net.py`、`main_Net.py`；
- 运行命令示例（Full/Hybrid）与验证结果截图；
- 消融开关说明以复现实验表格。